@inject IAuthorizationService AuthorizationService
@using Microsoft.AspNetCore.Authorization
@using XtremeIdiots.Portal.Web.Auth.Constants
@using XtremeIdiots.Portal.Web.Extensions
@using XtremeIdiots.Portal.Web.ViewModels
@using XtremeIdiots.Portal.Repository.Abstractions.Constants.V1
@using XtremeIdiots.Portal.Repository.Abstractions.Models.V1
@using XtremeIdiots.Portal.Repository.Abstractions.Models.V1.GameServers
@model IEnumerable<GameServerDto>

@{
    ViewData["Title"] = "Game Server Credentials";
}

@{
    var showFtpColumns = Model.Any(item => AuthorizationService.AuthorizeAsync(User, new Tuple<GameType,
    Guid>(item.GameType, item.GameServerId), AuthPolicies.ViewFtpCredential).Result.Succeeded);
    var showRconColumn = Model.Any(item => AuthorizationService.AuthorizeAsync(User, new Tuple<GameType,
    Guid>(item.GameType, item.GameServerId), AuthPolicies.ViewRconCredential).Result.Succeeded);
}

<div class="wrapper wrapper-content animated fadeInRight">

    <div class="alert alert-primary" role="alert">
        <i class="fa-solid fa-circle-info"></i> To reveal a password simply click on the ****** and you will be able to see
        and copy the password.
    </div>

    <div class="row">
        <div class="col-12">

            <div class="container-fluid">
                <div class="ibox">
                    <div class="ibox-content">
                        <div class="table-responsive">
                            <table class="table w-100">
                                <thead>
                                    <tr>
                                        <th scope="col">
                                            @Html.DisplayNameFor(model => model.GameType)
                                        </th>
                                        <th scope="col">
                                            @Html.DisplayNameFor(model => model.Title)
                                        </th>
                                        <th scope="col">
                                            @Html.DisplayNameFor(model => model.Hostname)
                                    </th>

                                    @if (showRconColumn)
                                    {
                                        <th>
                                            @Html.DisplayNameFor(model => model.RconPassword)
                                        </th>
                                    }

                                    @if (showFtpColumns)
                                    {
                                        <th>
                                            @Html.DisplayNameFor(model => model.FtpHostname)
                                        </th>
                                        <th>
                                            @Html.DisplayNameFor(model => model.FtpUsername)
                                        </th>
                                        <th>
                                            @Html.DisplayNameFor(model => model.FtpPassword)
                                        </th>
                                    }

                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>
                                            <game-type-icon game="@item.GameType"></game-type-icon>
                                        </td>
                                        <td>
                                            <server-name title="@item.Title" live-title="@item.LiveTitle"></server-name>
                                        </td>
                                        <td>
                                            <server-host host="@item.Hostname" port="@item.QueryPort"></server-host>
                                        </td>

                                        @if (showRconColumn)
                                        {
                                            if ((await AuthorizationService.AuthorizeAsync(User, new Tuple<GameType,
                                            Guid>(item.GameType, item.GameServerId), AuthPolicies.ViewRconCredential)).Succeeded
                                            && !string.IsNullOrWhiteSpace(item.RconPassword))
                                            {
                                                <td>
                                                    <span id="rconPassword-@item.GameServerId-dummy" class="credential-toggle cursor-pointer">
                                                        *******
                                                        <i class="fa-solid fa-eye"></i>
                                                    </span>
                                                    <span id="rconPassword-@item.GameServerId" class="credential-value" data-credential="@item.RconPassword"
                                                        style="display: none">
                                                        @item.RconPassword
                                                        <button class="btn btn-sm btn-link copy-btn" data-clipboard="@item.RconPassword" title="Copy to clipboard">
                                                            <i class="fa-solid fa-copy"></i>
                                                        </button>
                                                    </span>
                                                </td>
                                            }
                                            else
                                            {
                                                <td></td>
                                            }
                                        }

                                        @if (showFtpColumns)
                                        {
                                            if ((await AuthorizationService.AuthorizeAsync(User, new Tuple<GameType,
                                            Guid>(item.GameType, item.GameServerId), AuthPolicies.ViewFtpCredential)).Succeeded)
                                            {
                                                <td>
                                                    <span>@item.FtpHostname</span>
                                                </td>

                                                if (!string.IsNullOrWhiteSpace(item.FtpUsername))
                                                {
                                                    <td>
                                                        <span id="ftpUsername-@item.GameServerId-dummy" class="credential-toggle cursor-pointer">
                                                            *******
                                                            <i class="fa-solid fa-eye"></i>
                                                        </span>
                                                        <span id="ftpUsername-@item.GameServerId" class="credential-value" data-credential="@item.FtpUsername"
                                                            style="display: none">
                                                            @item.FtpUsername
                                                            <button class="btn btn-sm btn-link copy-btn" data-clipboard="@item.FtpUsername" title="Copy to clipboard">
                                                                <i class="fa-solid fa-copy"></i>
                                                            </button>
                                                        </span>
                                                    </td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }

                                                if (!string.IsNullOrWhiteSpace(item.FtpPassword))
                                                {
                                                    <td>
                                                        <span id="ftpPassword-@item.GameServerId-dummy" class="credential-toggle cursor-pointer">
                                                            *******
                                                            <i class="fa-solid fa-eye"></i>
                                                        </span>
                                                        <span id="ftpPassword-@item.GameServerId" class="credential-value" data-credential="@item.FtpPassword"
                                                            style="display: none">
                                                            @item.FtpPassword
                                                            <button class="btn btn-sm btn-link copy-btn" data-clipboard="@item.FtpPassword" title="Copy to clipboard">
                                                                <i class="fa-solid fa-copy"></i>
                                                            </button>
                                                        </span>
                                                    </td>
                                                }
                                                else
                                                {
                                                    <td></td>
                                                }
                                            }
                                            else
                                            {
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                            }
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="ibox-footer">

                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

@* ReSharper disable once Razor.SectionNotResolved *@

@section Scripts {

    <script type="text/javascript">
        $(document).ready(function () {
            // Toggle credential visibility
            $('.credential-toggle').click(function() {
                $(this).hide();
                $(this).next('.credential-value').show();
            });

            // Copy to clipboard functionality
            $('.copy-btn').click(function(e) {
                e.preventDefault();
                const textToCopy = $(this).data('clipboard');
                
                // Use modern Clipboard API if available
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy).then(function() {
                        showCopyToast();
                    }).catch(function(err) {
                        // Fallback to older method
                        fallbackCopyToClipboard(textToCopy);
                    });
                } else {
                    // Fallback for older browsers/mobile
                    fallbackCopyToClipboard(textToCopy);
                }
            });

            function fallbackCopyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showCopyToast();
                } catch (err) {
                    console.error('Fallback: Could not copy text', err);
                    alert('Failed to copy to clipboard');
                }
                
                document.body.removeChild(textArea);
            }

            function showCopyToast() {
                // Check if toastr is available (from the Inspinia template)
                if (typeof toastr !== 'undefined') {
                    toastr.success('Copied to clipboard!', 'Success', {
                        timeOut: 2000,
                        positionClass: 'toast-top-right'
                    });
                } else {
                    // Simple fallback alert
                    const toast = $('<div class="alert alert-success copy-toast">Copied to clipboard!</div>');
                    $('body').append(toast);
                    setTimeout(function() {
                        toast.fadeOut(function() { $(this).remove(); });
                    }, 2000);
                }
            }
        });
    </script>

}