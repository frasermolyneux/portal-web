@using XtremeIdiots.Portal.Web.Extensions
@using XtremeIdiots.Portal.Repository.Abstractions.Models.V1;
@using XtremeIdiots.Portal.Repository.Abstractions.Models.V1.GameServers
@model GameServerDto

@{
    ViewData["Title"] = "Rcon - " + Model.Title;
}

<div class="wrapper wrapper-content animated fadeInRight">

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-end mb-2">
                <button id="toggleRefresh" class="btn btn-sm btn-outline-info" data-testid="rcon-toggle-refresh">
                    <i class="fa fa-pause"></i> Pause Refresh
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>
                        <game-type-icon game="@Model.GameType" size="20" class="me-2" /> @Model.Title
                        <div class="btn-group ms-2" role="group">
                            <button type="button" class="btn btn-sm btn-link p-0 dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-testid="rcon-server-info-dropdown">
                                <i class="fa fa-info-circle text-primary"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="serverInfoBtn" data-testid="rcon-server-info-btn"><i class="fa fa-server"></i> Server Info</a></li>
                                <li><a class="dropdown-item" href="#" id="systemInfoBtn" data-testid="rcon-system-info-btn"><i class="fa fa-microchip"></i> System Info</a></li>
                                <li><a class="dropdown-item" href="#" id="commandListBtn" data-testid="rcon-command-list-btn"><i class="fa fa-list"></i> Command List</a></li>
                            </ul>
                        </div>
                    </h5>
                    <div class="ibox-tools">
                        <span class="badge bg-success" id="serverStatusIndicator">Online</span>
                    </div>
                </div>
                <div class="ibox-content">
                    <div id="serverInfoLoading" class="text-center text-muted" style="display: none;">
                        <i class="fa fa-spinner fa-spin"></i> Loading server info...
                    </div>
                    <div id="serverInfoContent">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <div id="currentMapImageContainer">
                                    <img id="currentMapImage" src="/images/noimage.jpg" alt="Current Map" class="img-fluid" style="max-height: 150px; width: auto;">
                                </div>
                            </div>
                            <div class="col-md-9">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4 col-md-3">Hostname:</dt>
                                    <dd class="col-sm-8 col-md-9" id="serverHostname">@Model.Hostname</dd>
                                    
                                    <dt class="col-sm-4 col-md-3">Current Map:</dt>
                                    <dd class="col-sm-8 col-md-9">
                                        <span id="currentMapName">Loading...</span>
                                    </dd>
                                    
                                    <dt class="col-sm-4 col-md-3">Players:</dt>
                                    <dd class="col-sm-8 col-md-9">
                                        <span id="playerCount">0</span> / <span id="maxPlayers">0</span>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ibox-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fa fa-clock"></i> <span id="serverStatusRefresh" title="Last refresh time">Just now</span>
                            <button id="manualRefreshBtn" class="btn btn-xs btn-link p-0 ms-2" type="button" title="Refresh now" data-testid="rcon-manual-refresh-btn">
                                <i class="fa fa-refresh"></i>
                            </button>
                        </small>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-testid="rcon-server-control-dropdown">
                                <i class="fa-solid fa-cog"></i> Server Control
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <button id="restartServer" class="dropdown-item" type="button" data-testid="rcon-btn-restart-server">
                                        <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> Restart Server
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-lg-8 col-md-12">
            <div class="container-fluid">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5>
                            Connected Players
                            <button id="connectedPlayersInfoBtn" class="btn btn-sm btn-link p-0 ms-2" type="button" 
                                    data-bs-toggle="tooltip" data-bs-placement="right" data-bs-html="true"
                                    title="<div class='text-start'><strong>Server Status</strong><br/><span id='connectedPlayersInfoTooltip'>Loading...</span></div>"
                                    data-testid="rcon-connected-players-info-btn">
                                <i class="fa fa-info-circle text-primary"></i>
                            </button>
                        </h5>
                    </div>
                    <div class="ibox-content">
                        <div class="table-responsive">
                            <table id="dataTable" class="table table-striped table-hover w-100">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Username</th>
                                        <th scope="col">Guid</th>
                                        <th scope="col">IP Address</th>
                                        <th scope="col">Rate</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="ibox-footer">
                        <small class="text-muted">
                            <i class="fa fa-clock"></i> <span id="playersTableRefresh" title="Last refresh time">Just now</span>
                            <button id="manualRefreshPlayersBtn" class="btn btn-xs btn-link p-0 ms-2" type="button" title="Refresh now" data-testid="rcon-manual-refresh-players-btn">
                                <i class="fa fa-refresh"></i>
                            </button>
                        </small>
                    </div>
                </div>

                <div class="ibox">
                    <div class="ibox-title">
                        <h5>Live Chat Log</h5>
                    </div>
                    <div class="ibox-content" style="max-height: 400px; overflow-y: auto;" id="chatLogContainer" role="log" aria-live="polite" aria-label="Live chat messages">
                        <div id="chatMessages">
                            <p class="text-muted text-center"><i class="fa fa-spinner fa-spin"></i> Loading chat messages...</p>
                        </div>
                    </div>
                    <div class="ibox-footer">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                                <span class="badge bg-primary" id="chatMessageCount">0</span>
                                <i class="fa fa-clock ms-2"></i> <span id="chatLogRefresh" title="Last refresh time">Just now</span>
                                <button id="manualRefreshChatBtn" class="btn btn-xs btn-link p-0 ms-2" type="button" title="Refresh now" data-testid="rcon-manual-refresh-chat-btn">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </small>
                        </div>
                        <form id="sayForm" class="d-flex gap-2">
                            <input type="text" id="sayMessage" class="form-control form-control-sm" placeholder="Type a message to send to server..." maxlength="255" data-testid="rcon-say-input">
                            <button type="submit" class="btn btn-sm btn-primary" id="saySend" data-testid="rcon-say-btn">
                                <i class="fa fa-paper-plane"></i> Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-12">

            <div class="ibox">
                <div class="ibox-title">
                    <h5>Map Control</h5>
                </div>
                <div class="ibox-content">
                    
                    <div class="mb-3">
                        <h6 class="mb-2">Map Rotation</h6>
                        <div id="mapRotationContainer" class="mb-3" style="display: none;">
                            <div id="mapRotationCarousel" class="d-flex overflow-auto gap-2 pb-2" style="scroll-behavior: smooth;">
                                <!-- Maps will be loaded here via JavaScript -->
                            </div>
                        </div>
                        <div id="mapRotationLoading" class="text-center text-muted">
                            <i class="fa fa-spinner fa-spin"></i> Loading map rotation...
                        </div>
                        <div id="mapRotationError" class="text-center text-danger" style="display: none;">
                            Failed to load map rotation
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="restartMap" class="btn btn-primary" type="button" data-testid="rcon-btn-restart-map">
                            <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> Restart Map
                        </button>

                        <button id="fastRestartMap" class="btn btn-primary" type="button" data-testid="rcon-btn-fast-restart-map">
                            <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> Fast Restart Map
                        </button>

                        <button id="nextMap" class="btn btn-primary" type="button" data-testid="rcon-btn-next-map">
                            <i class="fa-solid fa-forward" aria-hidden="true"></i> Next Map
                        </button>
                    </div>

                </div>
                <div class="ibox-footer">
                    <small class="text-muted">
                        <i class="fa fa-clock"></i> <span id="mapRotationRefresh" title="Last refresh time">Just now</span>
                        <button id="manualRefreshMapRotationBtn" class="btn btn-xs btn-link p-0 ms-2" type="button" title="Refresh now" data-testid="rcon-manual-refresh-map-rotation-btn">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </small>
                </div>
            </div>

        </div>

    </div>


</div>

@* ReSharper disable once Razor.SectionNotResolved *@

@section Styles {
    <environment names="Development">
        <link rel="stylesheet" href="~/lib/toastr/toastr.css" />
    </environment>
    <environment names="Staging,Production">
        <link rel="stylesheet" href="~/lib/toastr/toastr.min.css" />
    </environment>
    
    <style>
        .map-card {
            width: min(90vw, 200px);
            max-width: 200px;
            flex-shrink: 0;
            border: 2px solid #e7eaec;
            border-radius: 4px;
            background-color: #fff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .map-card:hover {
            border-color: #1ab394;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .map-card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background-color: #f3f3f4;
        }
        
        .map-card-body {
            padding: 10px;
        }
        
        .map-card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .map-card-btn {
            width: 100%;
        }
        
        #mapRotationCarousel::-webkit-scrollbar {
            height: 8px;
        }
        
        #mapRotationCarousel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #mapRotationCarousel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        #mapRotationCarousel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Mobile responsive improvements */
        @@media (max-width: 768px) {
            .map-card {
                width: min(80vw, 180px);
            }
            
            #chatLogContainer {
                max-height: clamp(250px, 40vh, 400px) !important;
            }
        }
    </style>
}

@* ReSharper disable once Razor.SectionNotResolved *@

@section Scripts {

    <environment names="Development">
        <script src="~/lib/toastr/toastr.js"></script>
    </environment>
    <environment names="Staging,Production">
        <script src="~/lib/toastr/toastr.min.js"></script>
    </environment>

    <form id="__af" method="post" style="display:none">@Html.AntiForgeryToken()</form>
    <script type="text/javascript">

        // Configuration constants
        const REFRESH_INTERVALS = {
            CHAT: 15000,        // 15 seconds
            PLAYERS: 10000,     // 10 seconds
            SERVER_STATUS: 10000, // 10 seconds
            BADGES: 5000        // 5 seconds
        };

        // State variables
        let lastChatMessageId = null;
        let refreshEnabled = true;
        let selectedPlayerSlot = null;
        
        // Track active intervals for cleanup
        const activeIntervals = [];
        
        // Track last refresh times for each section
        const lastRefreshTimes = {
            serverStatus: new Date(),
            players: new Date(),
            chatLog: new Date(),
            mapRotation: new Date()
        };
        
        // Helper function to update refresh badge
        function updateRefreshBadge(badgeId, lastRefreshTime) {
            const badge = $('#' + badgeId);
            if (badge.length && lastRefreshTime) {
                badge.text('Updated ' + timeAgo(formatDateTimeForTimeAgo(lastRefreshTime)));
            }
        }
        
        // Helper to format Date object for timeAgo function
        function formatDateTimeForTimeAgo(date) {
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
        }
        
        // AJAX error handler
        function handleAjaxError(xhr, textStatus, errorThrown) {
            console.error('AJAX Error:', { status: xhr.status, statusText: xhr.statusText, error: errorThrown });
            // Don't show toast for expected 404s or when paused
            if (xhr.status !== 404 && refreshEnabled) {
                showToast('error', 'Failed to load data. Please refresh the page.');
            }
        }
        
        // Cleanup function for page unload
        function cleanup() {
            // Clear all active intervals
            activeIntervals.forEach(intervalId => clearInterval(intervalId));
            activeIntervals.splice(0); // Clear array
            console.log('Cleaned up all intervals');
        }
        
        // Register cleanup on page unload
        window.addEventListener('beforeunload', cleanup);
        window.addEventListener('pagehide', cleanup);
        
        // Update all refresh badges
        function updateAllRefreshBadges() {
            updateRefreshBadge('serverStatusRefresh', lastRefreshTimes.serverStatus);
            updateRefreshBadge('playersTableRefresh', lastRefreshTimes.players);
            updateRefreshBadge('chatLogRefresh', lastRefreshTimes.chatLog);
            updateRefreshBadge('mapRotationRefresh', lastRefreshTimes.mapRotation);
        }
        
        // Helper function to show toast notifications
        function showToast(type, message, title) {
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: "toast-top-right",
                timeOut: 5000
            };
            
            if (type === 'success') {
                toastr.success(message, title || 'Success');
            } else if (type === 'error') {
                toastr.error(message, title || 'Error');
            } else if (type === 'warning') {
                toastr.warning(message, title || 'Warning');
            } else {
                toastr.info(message, title || 'Info');
            }
        }

        $(document).ready(function () {

            var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();
            
            // Initialize Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // Toggle refresh button
            $('#toggleRefresh').click(function() {
                refreshEnabled = !refreshEnabled;
                $(this).html(refreshEnabled ? 
                    '<i class="fa fa-pause"></i> Pause Refresh' : 
                    '<i class="fa fa-play"></i> Resume Refresh');
            });
            
            // Show info modal
            function showInfoModal(title, content) {
                var modalHtml = '<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">' +
                    '<div class="modal-dialog modal-lg modal-dialog-scrollable">' +
                        '<div class="modal-content">' +
                            '<div class="modal-header">' +
                                '<h5 class="modal-title" id="infoModalLabel">' + escapeHtml(title) + '</h5>' +
                                '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
                            '</div>' +
                            '<div class="modal-body">' +
                                '<pre class="mb-0" style="font-size: 11px; max-height: 500px; overflow-y: auto;">' + escapeHtml(content) + '</pre>' +
                            '</div>' +
                            '<div class="modal-footer">' +
                                '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
                
                // Remove any existing modal
                $('#infoModal').remove();
                $('body').append(modalHtml);
                var modal = new bootstrap.Modal(document.getElementById('infoModal'));
                modal.show();
                
                // Clean up modal when hidden
                $('#infoModal').on('hidden.bs.modal', function () {
                    $(this).remove();
                });
            }
            
            // Load server info for tooltip on Connected Players box
            function loadServerInfoForTooltip() {
                $.ajax({
                    url: '/ServerAdmin/GetServerStatus/@Model.GameServerId',
                    type: 'GET',
                    success: function(result) {
                        if (result.success) {
                            // Create a summary for the tooltip
                            var summaryHtml = 'Map: ' + (result.currentMap || 'Unknown') + '<br/>' +
                                             'Players: ' + (result.playerCount || 0) + '/' + (result.maxPlayers || 0);
                            
                            $('#connectedPlayersInfoBtn').attr('data-bs-original-title', 
                                '<div class="text-start"><strong>Server Status</strong><br/>' + summaryHtml + '</div>');
                            
                            // Update tooltip if already shown
                            var tooltip = bootstrap.Tooltip.getInstance(document.getElementById('connectedPlayersInfoBtn'));
                            if (tooltip) {
                                tooltip.setContent({
                                    '.tooltip-inner': '<div class="text-start"><strong>Server Status</strong><br/>' + summaryHtml + '</div>'
                                });
                            }
                        }
                    },
                    error: function() {
                        console.error('Failed to load server status for tooltip');
                    }
                });
            }
            
            // Handle server info button click
            $('#serverInfoBtn').click(function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/ServerAdmin/GetServerInfo/@Model.GameServerId',
                    type: 'GET',
                    success: function(result) {
                        if (result.success && result.serverInfo) {
                            showInfoModal('Server Information', result.serverInfo);
                        } else {
                            console.error('Server info request returned success=false:', result);
                            showToast('error', result.message || 'Failed to load server info');
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.error('Server info AJAX error:', { status: xhr.status, statusText: xhr.statusText, error: errorThrown, responseText: xhr.responseText });
                        showToast('error', 'Failed to load server info: ' + (xhr.responseJSON?.message || xhr.statusText || 'Unknown error'));
                    }
                });
            });
            
            // Handle system info button click
            $('#systemInfoBtn').click(function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/ServerAdmin/GetSystemInfo/@Model.GameServerId',
                    type: 'GET',
                    success: function(result) {
                        if (result.success && result.systemInfo) {
                            showInfoModal('System Information', result.systemInfo);
                        } else {
                            console.error('System info request returned success=false:', result);
                            showToast('error', result.message || 'Failed to load system info');
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.error('System info AJAX error:', { status: xhr.status, statusText: xhr.statusText, error: errorThrown, responseText: xhr.responseText });
                        showToast('error', 'Failed to load system info: ' + (xhr.responseJSON?.message || xhr.statusText || 'Unknown error'));
                    }
                });
            });
            
            // Handle command list button click
            $('#commandListBtn').click(function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/ServerAdmin/GetCommandList/@Model.GameServerId',
                    type: 'GET',
                    success: function(result) {
                        if (result.success && result.commandList) {
                            showInfoModal('Command List', result.commandList);
                        } else {
                            console.error('Command list request returned success=false:', result);
                            showToast('error', result.message || 'Failed to load command list');
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.error('Command list AJAX error:', { status: xhr.status, statusText: xhr.statusText, error: errorThrown, responseText: xhr.responseText });
                        showToast('error', 'Failed to load command list: ' + (xhr.responseJSON?.message || xhr.statusText || 'Unknown error'));
                    }
                });
            });

            // Load server status (current map and player count)
            function loadServerStatus() {
                if (!refreshEnabled) return;
                
                // Show loading indicator
                $('#serverInfoLoading').show();
                $('#serverInfoContent').css('opacity', '0.5');
                
                $.ajax({
                    url: '/ServerAdmin/GetCurrentMap/@Model.GameServerId',
                    type: 'GET',
                    success: function(result) {
                        if (result.success) {
                            $('#currentMapName').text(result.currentMap || 'Unknown');
                            
                            if (result.mapImageUri) {
                                $('#currentMapImage').attr('src', result.mapImageUri);
                            } else {
                                $('#currentMapImage').attr('src', '/images/noimage.jpg');
                            }
                            
                            lastRefreshTimes.serverStatus = new Date();
                            updateRefreshBadge('serverStatusRefresh', lastRefreshTimes.serverStatus);
                        } else {
                            $('#currentMapName').text('Unknown');
                            $('#currentMapImage').attr('src', '/images/noimage.jpg');
                        }
                        
                        // Hide loading indicator
                        $('#serverInfoLoading').hide();
                        $('#serverInfoContent').css('opacity', '1');
                    },
                    error: function() {
                        $('#serverStatusIndicator').removeClass('bg-success').addClass('bg-danger').text('Error');
                        $('#currentMapName').text('Error loading map');
                        $('#currentMapImage').attr('src', '/images/noimage.jpg');
                        
                        // Hide loading indicator
                        $('#serverInfoLoading').hide();
                        $('#serverInfoContent').css('opacity', '1');
                    }
                });
            }

            // Manual refresh button handler
            $('#manualRefreshBtn').click(function(e) {
                e.preventDefault();
                loadServerStatus();
                showToast('info', 'Refreshing server status...');
            });

            // Manual refresh button for players table
            $('#manualRefreshPlayersBtn').click(function(e) {
                e.preventDefault();
                playersTable.ajax.reload(null, false);
                showToast('info', 'Refreshing connected players...');
            });

            // Manual refresh button for chat log
            $('#manualRefreshChatBtn').click(function(e) {
                e.preventDefault();
                loadChatLog();
                showToast('info', 'Refreshing chat log...');
            });

            // Manual refresh button for map rotation
            $('#manualRefreshMapRotationBtn').click(function(e) {
                e.preventDefault();
                loadMapRotation();
                showToast('info', 'Refreshing map rotation...');
            });

            $("#restartServer").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to restart the server?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/RestartServer/@Model.GameServerId",
                    data: { __RequestVerificationToken: antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Server restart command sent successfully');
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to restart server: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            $("#restartMap").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to restart the map?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/RestartMap/@Model.GameServerId",
                    data: { __RequestVerificationToken: antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Map restart command sent successfully');
                        // Refresh server status after map command
                        setTimeout(function() {
                            loadServerStatus();
                        }, 2000);
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to restart map: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            $("#fastRestartMap").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to fast restart the map?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/FastRestartMap/@Model.GameServerId",
                    data: { __RequestVerificationToken: antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Fast restart command sent successfully');
                        // Refresh server status after map command
                        setTimeout(function() {
                            loadServerStatus();
                        }, 2000);
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to fast restart map: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            $("#nextMap").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to load the next map?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/NextMap/@Model.GameServerId",
                    data: { __RequestVerificationToken: antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Next map command sent successfully');
                        // Refresh server status after map command
                        setTimeout(function() {
                            loadServerStatus();
                        }, 2000);
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to load next map: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Load map rotation
            function loadMapRotation() {
                $.ajax({
                    type: "GET",
                    url: "/ServerAdmin/GetMapRotation/@Model.GameServerId",
                    success: function (result) {
                        if (result.success && result.maps && result.maps.length > 0) {
                            var carousel = $('#mapRotationCarousel');
                            carousel.empty();
                            
                            result.maps.forEach(function(map) {
                                var mapCard = $('<div>', { class: 'map-card', 'data-testid': 'map-card-' + map.mapName });
                                
                                // Map image
                                var imgSrc = map.hasImage && map.mapImageUri ? map.mapImageUri : '/images/noimage.jpg';
                                var mapImg = $('<img>', { 
                                    src: imgSrc, 
                                    class: 'map-card-image',
                                    alt: map.mapTitle,
                                    onerror: "this.src='/images/noimage.jpg'"
                                });
                                
                                // Map card body
                                var cardBody = $('<div>', { class: 'map-card-body' });
                                var mapTitle = $('<div>', { class: 'map-card-title', title: map.mapTitle }).text(map.mapTitle);
                                var loadBtn = $('<button>', { 
                                    class: 'btn btn-sm btn-primary map-card-btn load-map-btn',
                                    'data-map-name': map.mapName,
                                    'data-testid': 'load-map-' + map.mapName
                                }).html('<i class="fa-solid fa-play"></i> Load Map');
                                
                                cardBody.append(mapTitle);
                                cardBody.append(loadBtn);
                                mapCard.append(mapImg);
                                mapCard.append(cardBody);
                                carousel.append(mapCard);
                            });
                            
                            $('#mapRotationLoading').hide();
                            $('#mapRotationContainer').show();
                            
                            lastRefreshTimes.mapRotation = new Date();
                            updateRefreshBadge('mapRotationRefresh', lastRefreshTimes.mapRotation);
                        } else {
                            $('#mapRotationLoading').hide();
                            $('#mapRotationError').text('No maps in rotation').show();
                        }
                    },
                    error: function (xhr) {
                        $('#mapRotationLoading').hide();
                        $('#mapRotationError').text('Failed to load map rotation').show();
                    }
                });
            }
            
            // Handle load map button clicks
            $(document).on('click', '.load-map-btn', function(e) {
                e.preventDefault();
                var mapName = $(this).data('map-name');
                
                if (!confirm('Load map "' + mapName + '"?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/LoadMap/@Model.GameServerId',
                    data: { 
                        mapName: mapName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('success', result.message || 'Map load command sent');
                            // Refresh server status after map command
                            setTimeout(function() {
                                loadServerStatus();
                            }, 2000);
                        } else {
                            console.error('Load map request returned success=false:', result);
                            showToast('error', result.message || 'Failed to load map');
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.error('Load map AJAX error:', { status: xhr.status, statusText: xhr.statusText, error: errorThrown, responseText: xhr.responseText });
                        showToast('error', 'Error loading map: ' + (xhr.responseJSON?.message || xhr.statusText || 'Unknown error'));
                    }
                });
            });
            
            // Initial load of map rotation
            loadMapRotation();

            var playersTable = $('#dataTable').DataTable({
                processing: true,
                paging: false,
                info: false,
                searching: false,
                stateSave: true,
                responsive: {
                    details: {
                        type: 'inline',
                        target: 'tr'
                    }
                },
                autoWidth: false,
                order: [[0, "asc"]],
                ajax: {
                    url: '/ServerAdmin/GetRconPlayers/@Model.GameServerId',
                    dataSrc: function(json) {
                        lastRefreshTimes.players = new Date();
                        updateRefreshBadge('playersTableRefresh', lastRefreshTimes.players);
                        
                        // Update player count in server info
                        if (json.data) {
                            $('#playerCount').text(json.data.length || 0);
                        }
                        
                        return json.data;
                    },
                    error: handleAjaxError
                },
                columnDefs: [
                    { targets: 0, responsivePriority: 1 }, // # (Num) - always visible
                    { targets: 1, responsivePriority: 2 }, // Username - always visible
                    { targets: 2, responsivePriority: 5 }, // Guid - hide first on small screens
                    { targets: 3, responsivePriority: 4 }, // IP Address - hide on smaller screens
                    { targets: 4, responsivePriority: 6 }, // Rate - hide first on small screens
                    { targets: 5, responsivePriority: 3 }  // Actions - keep visible
                ],
                columns: [
                    {
                        data: 'num',
                        name: 'num',
                        width: '50px'
                    },
                    {
                        data: 'name',
                        name: 'name',
                        render: function (data, type, row) {
                            // Player name with profile link if available
                            if (row.playerId) {
                                return '<a href="/Players/Details/' + row.playerId + '">' + escapeHtml(row.name) + '</a>';
                            } else {
                                return escapeHtml(row.name);
                            }
                        }
                    },
                    {
                        data: 'guid',
                        name: 'guid',
                        sortable: false
                    },
                    {
                        data: 'ipAddress',
                        name: 'ipAddress',
                        sortable: false,
                        render: function (data, type, row) {
                            if (!data) return '';
                            return formatIPAddress(
                                row.ipAddress,
                                row.proxyCheckRiskScore || 0,
                                row.isProxy === true,
                                row.isVpn === true,
                                row.proxyType || '',
                                row.countryCode || '',
                                true
                            );
                        }
                    },
                    {
                        data: 'rate',
                        name: 'rate',
                        sortable: false
                    },
                    {
                        data: null,
                        sortable: false,
                        render: function (data, type, row) {
                            if (!row.num) return '';
                            
                            var playerSlot = row.num;
                            var playerGuid = row.guid || '';
                            var playerName = escapeHtml(row.name || 'Unknown');
                            
                            var kickBtn = '<button class="btn btn-sm btn-warning kick-player" data-slot="' + playerSlot + '" data-guid="' + playerGuid + '" data-name="' + playerName + '" data-testid="rcon-player-' + playerSlot + '-kick"><i class="fa-solid fa-user-xmark"></i> Kick</button> ';
                            var tempBanBtn = '<button class="btn btn-sm btn-danger tempban-player" data-slot="' + playerSlot + '" data-guid="' + playerGuid + '" data-name="' + playerName + '" data-testid="rcon-player-' + playerSlot + '-tempban"><i class="fa-solid fa-clock"></i> TempBan</button> ';
                            var banBtn = '<button class="btn btn-sm btn-danger ban-player" data-slot="' + playerSlot + '" data-guid="' + playerGuid + '" data-name="' + playerName + '" data-testid="rcon-player-' + playerSlot + '-ban"><i class="fa-solid fa-ban"></i> Ban</button>';
                            
                            return '<div class="btn-group btn-group-sm" role="group">' + kickBtn + tempBanBtn + banBtn + '</div>';
                        }
                    }
                ]
            });

            // Handle kick button clicks
            $('#dataTable').on('click', '.kick-player', function() {
                var playerSlot = $(this).data('slot');
                var playerGuid = $(this).data('guid') || '';
                var playerName = $(this).data('name') || 'this player';
                
                if (!confirm('Are you sure you want to kick ' + playerName + '?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/KickRconPlayer/@Model.GameServerId',
                    data: { 
                        playerSlot: playerSlot,
                        playerGuid: playerGuid,
                        playerName: playerName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('success', result.message || 'Player kicked successfully');
                            playersTable.ajax.reload();
                        } else {
                            showToast('error', result.message || 'Failed to kick player');
                        }
                    },
                    error: function(xhr) {
                        showToast('error', 'Error kicking player: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Handle temp ban button clicks
            $('#dataTable').on('click', '.tempban-player', function() {
                var playerSlot = $(this).data('slot');
                var playerGuid = $(this).data('guid') || '';
                var playerName = $(this).data('name') || 'this player';
                
                if (!confirm('Are you sure you want to temporarily ban ' + playerName + ' for 7 days?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/TempBanRconPlayer/@Model.GameServerId',
                    data: { 
                        playerSlot: playerSlot,
                        playerGuid: playerGuid,
                        playerName: playerName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('warning', result.message || 'Player temp banned successfully');
                            playersTable.ajax.reload();
                        } else {
                            showToast('error', result.message || 'Failed to temp ban player');
                        }
                    },
                    error: function(xhr) {
                        showToast('error', 'Error temp banning player: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Handle ban button clicks
            $('#dataTable').on('click', '.ban-player', function() {
                var playerSlot = $(this).data('slot');
                var playerGuid = $(this).data('guid') || '';
                var playerName = $(this).data('name') || 'this player';
                
                if (!confirm('Are you sure you want to permanently ban ' + playerName + '?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/BanRconPlayer/@Model.GameServerId',
                    data: { 
                        playerSlot: playerSlot,
                        playerGuid: playerGuid,
                        playerName: playerName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('warning', result.message || 'Player banned successfully', 'Player Banned');
                            playersTable.ajax.reload();
                        } else {
                            showToast('error', result.message || 'Failed to ban player');
                        }
                    },
                    error: function(xhr) {
                        showToast('error', 'Error banning player: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Reload player data every 10 seconds (respecting pause state)
            activeIntervals.push(setInterval(function () {
                if (refreshEnabled && !selectedPlayerSlot) {
                    playersTable.ajax.reload(null, false);
                }
            }, REFRESH_INTERVALS.PLAYERS));

            // Reload server status every 10 seconds
            activeIntervals.push(setInterval(function () {
                if (refreshEnabled) {
                    loadServerStatus();
                }
            }, REFRESH_INTERVALS.SERVER_STATUS));

            // Load and refresh chat log
            function loadChatLog() {
                if (!refreshEnabled) return;
                let url = '/ServerAdmin/GetServerLiveChatLog/@Model.GameServerId?minutes=30';
                if (lastChatMessageId) {
                    url += '&lastMessageId=' + lastChatMessageId;
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(result) {
                        if (result.messages && result.messages.length > 0) {
                            // Update the last message ID
                            lastChatMessageId = result.messages[0].chatMessageId;
                            
                            // Build messages HTML (newest first at top)
                            let messagesHtml = '';
                            for (let i = 0; i < result.messages.length; i++) {
                                const msg = result.messages[i];
                                const msgClass = msg.locked ? 'alert-warning' : 'alert-info';
                                const lockedBadge = msg.locked ? '<span class="badge bg-warning ms-2">Locked</span>' : '';
                                
                                messagesHtml += '<div class="alert ' + msgClass + ' alert-sm mb-1" data-testid="chat-message-' + msg.chatMessageId + '">';
                                messagesHtml += '<small class="text-muted">' + timeAgo(msg.timestamp) + '</small> ';
                                
                                if (msg.playerId) {
                                    messagesHtml += '<strong><a href="/Players/Details/' + msg.playerId + '" class="alert-link">' + escapeHtml(msg.username) + '</a></strong>';
                                } else {
                                    messagesHtml += '<strong>' + escapeHtml(msg.username) + '</strong>';
                                }
                                
                                messagesHtml += lockedBadge + ': ';
                                messagesHtml += escapeHtml(msg.message);
                                messagesHtml += '</div>';
                            }
                            
                            const container = $('#chatMessages');
                            if (container.find('p.text-muted').length > 0) {
                                // First load - replace loading message
                                container.html(messagesHtml);
                                $('#chatMessageCount').text(result.messages.length);
                            } else {
                                // Prepend new messages at the top (newest messages at top)
                                container.prepend(messagesHtml);
                                $('#chatMessageCount').text(result.messages.length + ' new');
                            }
                            
                            // Scroll to top to show newest messages
                            $('#chatLogContainer').scrollTop(0);
                            
                            // Update refresh time
                            lastRefreshTimes.chatLog = new Date();
                            updateRefreshBadge('chatLogRefresh', lastRefreshTimes.chatLog);
                        } else if (!lastChatMessageId) {
                            $('#chatMessages').html('<p class="text-muted text-center">No recent chat messages</p>');
                            $('#chatMessageCount').text('0');
                        } else {
                            $('#chatMessageCount').text('0 new');
                        }
                    },
                    error: function(xhr) {
                        console.error('Failed to load chat log:', xhr);
                        if (!lastChatMessageId) {
                            $('#chatMessages').html('<p class="text-danger text-center">Failed to load chat messages</p>');
                        }
                    }
                });
            }
            
            // Handle Say form submission
            $('#sayForm').submit(function(e) {
                e.preventDefault();
                const message = $('#sayMessage').val().trim();
                
                if (!message) {
                    showToast('warning', 'Please enter a message');
                    return;
                }
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/SendSayCommand/@Model.GameServerId',
                    data: {
                        message: message,
                        __RequestVerificationToken: antiForgeryToken
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('success', result.message || 'Message sent successfully');
                            $('#sayMessage').val('');
                            // Reload chat log after a short delay to see the message
                            setTimeout(loadChatLog, 1000);
                        } else {
                            console.error('Send say command returned success=false:', result);
                            showToast('error', result.message || 'Failed to send message');
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.error('Send say command AJAX error:', { status: xhr.status, statusText: xhr.statusText, error: errorThrown, responseText: xhr.responseText });
                        showToast('error', 'Error sending message: ' + (xhr.responseJSON?.message || xhr.statusText || 'Unknown error'));
                    }
                });
            });

            // Initial load
            loadChatLog();
            loadServerStatus();
            loadServerInfoForTooltip();

            // Refresh chat log periodically
            activeIntervals.push(setInterval(loadChatLog, REFRESH_INTERVALS.CHAT));
            
            // Update all refresh badges every 5 seconds
            activeIntervals.push(setInterval(updateAllRefreshBadges, REFRESH_INTERVALS.BADGES));
            
            // Initial load of map rotation
            loadMapRotation();
        });

    </script>
}
