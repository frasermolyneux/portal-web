@using XtremeIdiots.Portal.Web.Extensions
@using XtremeIdiots.Portal.Repository.Abstractions.Models.V1;
@using XtremeIdiots.Portal.Repository.Abstractions.Models.V1.GameServers
@model GameServerDto

@{
    ViewData["Title"] = "Rcon - " + Model.Title;
}

<div class="wrapper wrapper-content animated fadeInRight">

    <div class="alert alert-info" role="alert">
        <i class="fa-solid fa-circle-info"></i> Live RCON View - Player information is enriched with profiles, geolocation, and risk assessment data
    </div>

    <div class="row">

        <div class="col-lg-8 col-md-12">
            <div class="container-fluid">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5>Connected Players</h5>
                    </div>
                    <div class="ibox-content">
                        <div class="table-responsive">
                            <table id="dataTable" class="table table-striped table-hover w-100">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Username</th>
                                        <th scope="col">Guid</th>
                                        <th scope="col">IP Address</th>
                                        <th scope="col">Rate</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="ibox">
                    <div class="ibox-title">
                        <h5>Live Chat Log</h5>
                        <div class="ibox-tools">
                            <span class="badge bg-primary" id="chatMessageCount">0</span>
                        </div>
                    </div>
                    <div class="ibox-content" style="max-height: 400px; overflow-y: auto;" id="chatLogContainer">
                        <div id="chatMessages">
                            <p class="text-muted text-center">Loading chat messages...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-12">

            <div class="ibox">
                <div class="ibox-title">
                    <h5>Server Control</h5>
                </div>
                <div class="ibox-content">
                    <div class="d-grid">
                        <button id="restartServer" class="btn btn-primary" type="button" data-testid="rcon-btn-restart-server">
                            <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> Restart Server
                        </button>
                    </div>
                </div>
            </div>

            <div class="ibox">
                <div class="ibox-title">
                    <h5>Map Control</h5>
                </div>
                <div class="ibox-content">
                    
                    <div class="mb-3">
                        <h6 class="mb-2">Map Rotation</h6>
                        <div id="mapRotationContainer" class="mb-3" style="display: none;">
                            <div id="mapRotationCarousel" class="d-flex overflow-auto gap-2 pb-2" style="scroll-behavior: smooth;">
                                <!-- Maps will be loaded here via JavaScript -->
                            </div>
                        </div>
                        <div id="mapRotationLoading" class="text-center text-muted">
                            <i class="fa fa-spinner fa-spin"></i> Loading map rotation...
                        </div>
                        <div id="mapRotationError" class="text-center text-danger" style="display: none;">
                            Failed to load map rotation
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="restartMap" class="btn btn-primary" type="button" data-testid="rcon-btn-restart-map">
                            <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> Restart Map
                        </button>

                        <button id="fastRestartMap" class="btn btn-primary" type="button" data-testid="rcon-btn-fast-restart-map">
                            <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i> Fast Restart Map
                        </button>

                        <button id="nextMap" class="btn btn-primary" type="button" data-testid="rcon-btn-next-map">
                            <i class="fa-solid fa-forward" aria-hidden="true"></i> Next Map
                        </button>
                    </div>

                </div>
            </div>

        </div>

    </div>


</div>

@* ReSharper disable once Razor.SectionNotResolved *@

@section Styles {
    <environment names="Development">
        <link rel="stylesheet" href="~/lib/toastr/toastr.css" />
    </environment>
    <environment names="Staging,Production">
        <link rel="stylesheet" href="~/lib/toastr/toastr.min.css" />
    </environment>
    
    <style>
        .map-card {
            min-width: 200px;
            max-width: 200px;
            flex-shrink: 0;
            border: 2px solid #e7eaec;
            border-radius: 4px;
            background-color: #fff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .map-card:hover {
            border-color: #1ab394;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .map-card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background-color: #f3f3f4;
        }
        
        .map-card-body {
            padding: 10px;
        }
        
        .map-card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .map-card-btn {
            width: 100%;
        }
        
        #mapRotationCarousel::-webkit-scrollbar {
            height: 8px;
        }
        
        #mapRotationCarousel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #mapRotationCarousel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        #mapRotationCarousel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
}

@* ReSharper disable once Razor.SectionNotResolved *@

@section Scripts {

    <environment names="Development">
        <script src="~/lib/toastr/toastr.js"></script>
    </environment>
    <environment names="Staging,Production">
        <script src="~/lib/toastr/toastr.min.js"></script>
    </environment>

    <form id="__af" method="post" style="display:none">@Html.AntiForgeryToken()</form>
    <script type="text/javascript">

        var lastChatMessageId = null;
        var chatRefreshInterval = 15000; // 15 seconds

        $(document).ready(function () {

            var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

            $("#restartServer").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to restart the server?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/RestartServer/@Model.GameServerId",
                    headers: { 'RequestVerificationToken': antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Server restart command sent successfully');
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to restart server: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            $("#restartMap").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to restart the map?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/RestartMap/@Model.GameServerId",
                    headers: { 'RequestVerificationToken': antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Map restart command sent successfully');
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to restart map: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            $("#fastRestartMap").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to fast restart the map?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/FastRestartMap/@Model.GameServerId",
                    headers: { 'RequestVerificationToken': antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Fast restart command sent successfully');
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to fast restart map: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            $("#nextMap").click(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to load the next map?')) return;
                $.ajax({
                    type: "POST",
                    url: "/ServerAdmin/NextMap/@Model.GameServerId",
                    headers: { 'RequestVerificationToken': antiForgeryToken },
                    success: function (result) {
                        showToast('success', 'Next map command sent successfully');
                    },
                    error: function (xhr) {
                        showToast('error', 'Failed to load next map: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Load map rotation
            function loadMapRotation() {
                $.ajax({
                    type: "GET",
                    url: "/ServerAdmin/GetMapRotation/@Model.GameServerId",
                    success: function (result) {
                        if (result.success && result.maps && result.maps.length > 0) {
                            var carousel = $('#mapRotationCarousel');
                            carousel.empty();
                            
                            result.maps.forEach(function(map) {
                                var mapCard = $('<div>', { class: 'map-card', 'data-testid': 'map-card-' + map.mapName });
                                
                                // Map image
                                var imgSrc = map.hasImage && map.mapImageUri ? map.mapImageUri : '/images/maps/default-map.jpg';
                                var mapImg = $('<img>', { 
                                    src: imgSrc, 
                                    class: 'map-card-image',
                                    alt: map.mapTitle,
                                    onerror: "this.src='/images/maps/default-map.jpg'"
                                });
                                
                                // Map card body
                                var cardBody = $('<div>', { class: 'map-card-body' });
                                var mapTitle = $('<div>', { class: 'map-card-title', title: map.mapTitle }).text(map.mapTitle);
                                var loadBtn = $('<button>', { 
                                    class: 'btn btn-sm btn-primary map-card-btn load-map-btn',
                                    'data-map-name': map.mapName,
                                    'data-testid': 'load-map-' + map.mapName
                                }).html('<i class="fa-solid fa-play"></i> Load Map');
                                
                                cardBody.append(mapTitle);
                                cardBody.append(loadBtn);
                                mapCard.append(mapImg);
                                mapCard.append(cardBody);
                                carousel.append(mapCard);
                            });
                            
                            $('#mapRotationLoading').hide();
                            $('#mapRotationContainer').show();
                        } else {
                            $('#mapRotationLoading').hide();
                            $('#mapRotationError').text('No maps in rotation').show();
                        }
                    },
                    error: function (xhr) {
                        $('#mapRotationLoading').hide();
                        $('#mapRotationError').text('Failed to load map rotation').show();
                    }
                });
            }
            
            // Handle load map button clicks
            $(document).on('click', '.load-map-btn', function(e) {
                e.preventDefault();
                var mapName = $(this).data('map-name');
                
                if (!confirm('Load map "' + mapName + '"?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/LoadMap/@Model.GameServerId',
                    data: { 
                        mapName: mapName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('success', result.message || 'Map load command sent');
                        } else {
                            showToast('error', result.message || 'Failed to load map');
                        }
                    },
                    error: function(xhr) {
                        showToast('error', 'Error loading map: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });
            
            // Initial load of map rotation
            loadMapRotation();

            var playersTable = $('#dataTable').DataTable({
                processing: true,
                pageLength: 50,
                stateSave: true,
                responsive: {
                    details: {
                        type: 'inline',
                        target: 'tr'
                    }
                },
                autoWidth: false,
                order: [[0, "asc"]],
                ajax: {
                    url: '/ServerAdmin/GetRconPlayers/@Model.GameServerId',
                    dataSrc: 'data',
                    error: handleAjaxError
                },
                columnDefs: [
                    { targets: 0, responsivePriority: 1 }, // # (Num) - always visible
                    { targets: 1, responsivePriority: 2 }, // Username - always visible
                    { targets: 2, responsivePriority: 5 }, // Guid - hide first on small screens
                    { targets: 3, responsivePriority: 4 }, // IP Address - hide on smaller screens
                    { targets: 4, responsivePriority: 6 }, // Rate - hide first on small screens
                    { targets: 5, responsivePriority: 3 }  // Actions - keep visible
                ],
                columns: [
                    {
                        data: 'num',
                        name: 'num',
                        width: '50px'
                    },
                    {
                        data: 'name',
                        name: 'name',
                        render: function (data, type, row) {
                            // Player name with profile link if available
                            if (row.playerId) {
                                return '<a href="/Players/Details/' + row.playerId + '">' + escapeHtml(row.name) + '</a>';
                            } else {
                                return escapeHtml(row.name);
                            }
                        }
                    },
                    {
                        data: 'guid',
                        name: 'guid',
                        sortable: false
                    },
                    {
                        data: 'ipAddress',
                        name: 'ipAddress',
                        sortable: false,
                        render: function (data, type, row) {
                            if (!data) return '';
                            return formatIPAddress(
                                row.ipAddress,
                                row.proxyCheckRiskScore || 0,
                                row.isProxy === true,
                                row.isVpn === true,
                                row.proxyType || '',
                                row.countryCode || '',
                                true
                            );
                        }
                    },
                    {
                        data: 'rate',
                        name: 'rate',
                        sortable: false
                    },
                    {
                        data: null,
                        sortable: false,
                        render: function (data, type, row) {
                            if (!row.num) return '';
                            
                            var playerSlot = row.num;
                            var playerGuid = row.guid || '';
                            var playerName = escapeHtml(row.name || 'Unknown');
                            
                            var kickBtn = '<button class="btn btn-sm btn-warning kick-player" data-slot="' + playerSlot + '" data-guid="' + playerGuid + '" data-name="' + playerName + '" data-testid="rcon-player-' + playerSlot + '-kick"><i class="fa-solid fa-user-xmark"></i> Kick</button> ';
                            var tempBanBtn = '<button class="btn btn-sm btn-danger tempban-player" data-slot="' + playerSlot + '" data-guid="' + playerGuid + '" data-name="' + playerName + '" data-testid="rcon-player-' + playerSlot + '-tempban"><i class="fa-solid fa-clock"></i> TempBan</button> ';
                            var banBtn = '<button class="btn btn-sm btn-danger ban-player" data-slot="' + playerSlot + '" data-guid="' + playerGuid + '" data-name="' + playerName + '" data-testid="rcon-player-' + playerSlot + '-ban"><i class="fa-solid fa-ban"></i> Ban</button>';
                            
                            return '<div class="btn-group btn-group-sm" role="group">' + kickBtn + tempBanBtn + banBtn + '</div>';
                        }
                    }
                ]
            });

            // Handle kick button clicks
            $('#dataTable').on('click', '.kick-player', function() {
                var playerSlot = $(this).data('slot');
                var playerGuid = $(this).data('guid') || '';
                var playerName = $(this).data('name') || 'this player';
                
                if (!confirm('Are you sure you want to kick ' + playerName + '?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/KickRconPlayer/@Model.GameServerId',
                    data: { 
                        playerSlot: playerSlot,
                        playerGuid: playerGuid,
                        playerName: playerName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('success', result.message || 'Player kicked successfully');
                            playersTable.ajax.reload();
                        } else {
                            showToast('error', result.message || 'Failed to kick player');
                        }
                    },
                    error: function(xhr) {
                        showToast('error', 'Error kicking player: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Handle temp ban button clicks
            $('#dataTable').on('click', '.tempban-player', function() {
                var playerSlot = $(this).data('slot');
                var playerGuid = $(this).data('guid') || '';
                var playerName = $(this).data('name') || 'this player';
                
                if (!confirm('Are you sure you want to temporarily ban ' + playerName + ' for 7 days?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/TempBanRconPlayer/@Model.GameServerId',
                    data: { 
                        playerSlot: playerSlot,
                        playerGuid: playerGuid,
                        playerName: playerName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('warning', result.message || 'Player temp banned successfully');
                            playersTable.ajax.reload();
                        } else {
                            showToast('error', result.message || 'Failed to temp ban player');
                        }
                    },
                    error: function(xhr) {
                        showToast('error', 'Error temp banning player: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Handle ban button clicks
            $('#dataTable').on('click', '.ban-player', function() {
                var playerSlot = $(this).data('slot');
                var playerGuid = $(this).data('guid') || '';
                var playerName = $(this).data('name') || 'this player';
                
                if (!confirm('Are you sure you want to permanently ban ' + playerName + '?')) return;
                
                $.ajax({
                    type: 'POST',
                    url: '/ServerAdmin/BanRconPlayer/@Model.GameServerId',
                    data: { 
                        playerSlot: playerSlot,
                        playerGuid: playerGuid,
                        playerName: playerName,
                        __RequestVerificationToken: antiForgeryToken 
                    },
                    success: function(result) {
                        if (result.success) {
                            showToast('error', result.message || 'Player banned successfully', 'Player Banned');
                            playersTable.ajax.reload();
                        } else {
                            showToast('error', result.message || 'Failed to ban player');
                        }
                    },
                    error: function(xhr) {
                        showToast('error', 'Error banning player: ' + (xhr.responseText || 'Unknown error'));
                    }
                });
            });

            // Reload player data every 10 seconds
            setInterval(function () {
                playersTable.ajax.reload(null, false);
            }, 10000);

            // Load and refresh chat log
            function loadChatLog() {
                var url = '/ServerAdmin/GetServerLiveChatLog/@Model.GameServerId?minutes=30';
                if (lastChatMessageId) {
                    url += '&lastMessageId=' + lastChatMessageId;
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(result) {
                        if (result.messages && result.messages.length > 0) {
                            // Update the last message ID
                            lastChatMessageId = result.messages[0].chatMessageId;
                            
                            // Prepend new messages
                            var messagesHtml = '';
                            for (var i = result.messages.length - 1; i >= 0; i--) {
                                var msg = result.messages[i];
                                var msgClass = msg.locked ? 'alert-warning' : 'alert-info';
                                var lockedBadge = msg.locked ? '<span class="badge bg-warning ms-2">Locked</span>' : '';
                                
                                messagesHtml += '<div class="alert ' + msgClass + ' alert-sm mb-1" data-testid="chat-message-' + msg.chatMessageId + '">';
                                messagesHtml += '<small class="text-muted">' + formatDateTime(msg.timestamp) + '</small> ';
                                
                                if (msg.playerId) {
                                    messagesHtml += '<strong><a href="/Players/Details/' + msg.playerId + '" class="alert-link">' + escapeHtml(msg.username) + '</a></strong>';
                                } else {
                                    messagesHtml += '<strong>' + escapeHtml(msg.username) + '</strong>';
                                }
                                
                                messagesHtml += lockedBadge + ': ';
                                messagesHtml += escapeHtml(msg.message);
                                messagesHtml += '</div>';
                            }
                            
                            var container = $('#chatMessages');
                            if (container.find('p.text-muted').length > 0) {
                                container.html(messagesHtml);
                            } else {
                                container.prepend(messagesHtml);
                            }
                            
                            // Update message count
                            $('#chatMessageCount').text(result.messages.length + ' new');
                            
                            // Auto-scroll to bottom only if we're near the bottom
                            var chatContainer = $('#chatLogContainer');
                            var isNearBottom = chatContainer[0].scrollHeight - chatContainer.scrollTop() - chatContainer.height() < 100;
                            if (isNearBottom || !lastChatMessageId) {
                                chatContainer.scrollTop(chatContainer[0].scrollHeight);
                            }
                        } else if (!lastChatMessageId) {
                            $('#chatMessages').html('<p class="text-muted text-center">No recent chat messages</p>');
                            $('#chatMessageCount').text('0');
                        } else {
                            $('#chatMessageCount').text('0 new');
                        }
                    },
                    error: function(xhr) {
                        console.error('Failed to load chat log:', xhr);
                        if (!lastChatMessageId) {
                            $('#chatMessages').html('<p class="text-danger text-center">Failed to load chat messages</p>');
                        }
                    }
                });
            }

            // Initial load
            loadChatLog();

            // Refresh chat log periodically
            setInterval(loadChatLog, chatRefreshInterval);
        });

    </script>
}
